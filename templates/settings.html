<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | ETR System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ETR System</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                    <li><a href="{{ url_for('create_receipt') }}"><i class="fas fa-receipt"></i> <span>Create Receipt</span></a></li>
                    <li><a href="{{ url_for('import_receipt') }}"><i class="fas fa-file-import"></i> <span>Import Receipt</span></a></li>
                    <li><a href="{{ url_for('receipts') }}"><i class="fas fa-list"></i> <span>Receipts</span></a></li>
                    <li><a href="{{ url_for('reports') }}"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
                    <li><a href="{{ url_for('settings') }}" class="active"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                    {% if current_user.role == 'admin' %}
                    <li><a href="{{ url_for('manage_users') }}"><i class="fas fa-users"></i> <span>Manage Users</span></a></li>
                    {% endif %}
                    <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
                </ul>
            </nav>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>System Settings</h1>
                <div class="user-menu">
                    <div class="user-info">
                        <div class="user-name">{{ current_user.username }}</div>
                        <div class="user-role">{{ current_user.role|title }}</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>Business Information</h2>
                <form id="businessSettingsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="businessName">Business Name *</label>
                            <input type="text" id="businessName" name="business_name" value="{{ user_data.business_name }}" required>
                        </div>
                        <div class="form-group">
                            <label for="kraPin">KRA PIN *</label>
                            <input type="text" id="kraPin" name="kra_pin" value="{{ user_data.kra_pin }}" pattern="[A-Z]\d{9}[A-Z]" title="Format: A123456789X" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number *</label>
                            <input type="tel" id="phoneNumber" name="phone_number" value="{{ user_data.phone_number }}" required>
                        </div>
                        <div class="form-group">
                            <label for="personInCharge">Person In Charge *</label>
                            <input type="text" id="personInCharge" name="person_in_charge" value="{{ user_data.person_in_charge }}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="townCity">Town/City *</label>
                        <input type="text" id="townCity" name="town_city" value="{{ user_data.town_city }}" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Save Business Information</button>
                    </div>
                </form>
            </div>

            <div class="chart-container">
                <h2>Receipt Settings</h2>
                <form id="receiptSettingsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiptPrefix">Receipt Prefix</label>
                            <input type="text" id="receiptPrefix" name="receipt_prefix" value="{{ user_data.receipt_prefix }}" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="vatRate">VAT Rate (%)</label>
                            <input type="number" id="vatRate" name="vat_rate" value="{{ user_data.vat_rate }}" step="0.1" min="0" max="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="include_address" {% if user_data.include_address %}checked{% endif %}>
                            Include business address on receipts
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="auto_print" {% if user_data.auto_print %}checked{% endif %}>
                            Auto-print receipts after generation
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Save Receipt Settings</button>
                    </div>
                </form>
            </div>

            <div class="chart-container">
                <h2>API Integration</h2>
                <div class="form-group">
                    <label>API Key</label>
                    <div class="api-key">{{ user_data.api_key }}</div>
                    <small>Use this key to integrate with your POS system</small>
                </div>
            </div>

            <div class="chart-container">
                <h2>System Maintenance</h2>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="backupData()">
                        <i class="fas fa-download"></i> Backup Data
                    </button>
                    <button class="btn btn-outline" onclick="generateKRAReport()">
                        <i class="fas fa-file-pdf"></i> Generate KRA Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Business Settings Form
        document.getElementById('businessSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            saveSettings(data);
        });

        // Receipt Settings Form
        document.getElementById('receiptSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.include_address = document.querySelector('input[name="include_address"]').checked;
            data.auto_print = document.querySelector('input[name="auto_print"]').checked;
            data.vat_rate = parseFloat(data.vat_rate);
            
            saveSettings(data);
        });

        function saveSettings(data) {
            fetch('/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings: ' + result.error);
                }
            })
            .catch(error => {
                alert('Error saving settings: ' + error);
            });
        }

        function backupData() {
            fetch('/api/backup')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Backup created successfully! File: ' + result.backup_file);
                    } else {
                        alert('Error creating backup: ' + result.error);
                    }
                });
        }

        function generateKRAReport() {
            const dateFrom = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0].substring(0, 8) + '01');
            const dateTo = prompt('Enter end date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            
            if (dateFrom && dateTo) {
                window.open(`/api/kra-report?date_from=${dateFrom}&date_to=${dateTo}`, '_blank');
            }
        }
    </script>
</body>
</html>